{"version":3,"file":"oauth2.base.esm.js","sources":["../../src/providers/oauth2.base.ts"],"sourcesContent":["import { Provider } from \"./base\";\r\nexport class OAuth2BaseProvider extends Provider {\r\n    async signin(request, auth) {\r\n        const { method, host, query } = request;\r\n        const state = [`redirect=${query.get(\"redirect\") ?? this.getUri(auth, \"/\", host)}`].join(\",\");\r\n        const base64State = Buffer.from(state).toString(\"base64\");\r\n        const nonce = Math.round(Math.random() * 1000).toString();\r\n        const url = await this.getAuthorizationUrl(request, auth, base64State, nonce);\r\n        if (method === \"POST\") {\r\n            return {\r\n                body: {\r\n                    redirect: url,\r\n                },\r\n            };\r\n        }\r\n        return {\r\n            status: 302,\r\n            headers: {\r\n                Location: url,\r\n            },\r\n        };\r\n    }\r\n    getStateValue(query, name) {\r\n        if (query.get(\"state\")) {\r\n            const state = Buffer.from(query.get(\"state\"), \"base64\").toString();\r\n            return state\r\n                .split(\",\")\r\n                .find((state) => state.startsWith(`${name}=`))\r\n                ?.replace(`${name}=`, \"\");\r\n        }\r\n    }\r\n    async callback({ query, host }, auth) {\r\n        const code = query.get(\"code\");\r\n        const redirect = this.getStateValue(query, \"redirect\");\r\n        const tokens = await this.getTokens(code, this.getCallbackUri(auth, host));\r\n        let user = await this.getUserProfile(tokens);\r\n        if (this.config.profile) {\r\n            user = await this.config.profile(user, tokens);\r\n        }\r\n        return [user, redirect ?? this.getUri(auth, \"/\", host)];\r\n    }\r\n}\r\n"],"names":[],"mappings":";;iCACwC,SAAS;AAAA,QACvC,OAAO,SAAS,MAAM;AACxB,UAAM,EAAE,QAAQ,MAAM,UAAU;AAChC,UAAM,QAAQ,CAAC,YAAY,MAAM,IAAI,eAAe,KAAK,OAAO,MAAM,KAAK,SAAS,KAAK;AACzF,UAAM,cAAc,OAAO,KAAK,OAAO,SAAS;AAChD,UAAM,QAAQ,KAAK,MAAM,KAAK,WAAW,KAAM;AAC/C,UAAM,MAAM,MAAM,KAAK,oBAAoB,SAAS,MAAM,aAAa;AACvE,QAAI,WAAW,QAAQ;AACnB,aAAO;AAAA,QACH,MAAM;AAAA,UACF,UAAU;AAAA;AAAA;AAAA;AAItB,WAAO;AAAA,MACH,QAAQ;AAAA,MACR,SAAS;AAAA,QACL,UAAU;AAAA;AAAA;AAAA;AAAA,EAItB,cAAc,OAAO,MAAM;AACvB,QAAI,MAAM,IAAI,UAAU;AACpB,YAAM,QAAQ,OAAO,KAAK,MAAM,IAAI,UAAU,UAAU;AACxD,aAAO,MACF,MAAM,KACN,KAAK,CAAC,WAAU,OAAM,WAAW,GAAG,WACnC,QAAQ,GAAG,SAAS;AAAA;AAAA;AAAA,QAG5B,SAAS,EAAE,OAAO,QAAQ,MAAM;AAClC,UAAM,OAAO,MAAM,IAAI;AACvB,UAAM,WAAW,KAAK,cAAc,OAAO;AAC3C,UAAM,SAAS,MAAM,KAAK,UAAU,MAAM,KAAK,eAAe,MAAM;AACpE,QAAI,OAAO,MAAM,KAAK,eAAe;AACrC,QAAI,KAAK,OAAO,SAAS;AACrB,aAAO,MAAM,KAAK,OAAO,QAAQ,MAAM;AAAA;AAE3C,WAAO,CAAC,MAAM,YAAY,KAAK,OAAO,MAAM,KAAK;AAAA;AAAA;;;;"}